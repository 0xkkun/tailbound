# 적 스폰 시스템 (Enemy Spawn System)

> 시간대별 적 출현 시스템 및 난이도 곡선 설계

**작성일**: 2025-11-08
**상태**: ✅ 구현 완료
**관련 파일**:
- [SpawnSystem.ts](../../src/systems/SpawnSystem.ts)
- [balance.config.ts](../../src/config/balance.config.ts)
- [enemies.ts](../../src/game/data/enemies.ts)

---

## 📋 목차

1. [개요](#개요)
2. [시간대별 구간 설계](#시간대별-구간-설계)
3. [웨이브 스폰 시스템](#웨이브-스폰-시스템)
4. [난이도 곡선](#난이도-곡선)
5. [밸런스 수치](#밸런스-수치)
6. [구현 세부사항](#구현-세부사항)

---

## 개요

### 설계 목표

- ✅ **단계적 학습 곡선**: 튜토리얼부터 최종 보스까지 자연스러운 난이도 상승
- ✅ **다양성**: 시간대별 새로운 적 타입 등장으로 지루함 방지
- ✅ **긴장감**: 몰려오는 느낌을 주는 웨이브 시스템
- ✅ **공정성**: 플레이어 성장에 맞춘 적절한 밸런스

### 핵심 메커니즘

1. **시간대별 구간 시스템**: 0-10분을 5단계로 나누어 각 구간마다 새로운 적 등장
2. **웨이브 스폰**: 여러 방향에서 그룹 단위로 적 생성
3. **티어 시스템**: low/medium/high 3단계 난이도
4. **동적 난이도**: 게임 시간에 따라 스폰 간격 감소 및 그룹 수 증가

---

## 시간대별 구간 설계

### 0분: 초급

**목표**: 게임 기본 메커니즘 익히기

| 항목 | 설정 |
|------|------|
| **등장 적** | 스켈레톤, 도깨비 |
| **난이도 분포** | low 100% |

**적 특징**:
- **스켈레톤** (빠른 약체): 기본 근접 추격 AI, 체력 낮음
- **도깨비** (탱커): 느린 속도, 매우 높은 체력, 높은 공격력

**학습 포인트**:
- 적 추적 AI 패턴 이해
- 이동 조작 및 거리 유지
- 자동 공격 메커니즘 이해
- 빠른 약체 vs 느린 탱커 차이 체감

---

### 1분: + 여우, 탈령

**목표**: 다양한 적 타입 소개

| 항목 | 설정 |
|------|------|
| **등장 적** | 0분 적 + **여우, 탈령** |
| **난이도 분포** | low 90% / medium 10% |

**신규 적 특징**:
- **여우** (균형형): 빠른 속도, 높은 체력
- **탈령** (암살자): 매우 빠른 속도, 높은 공격력, 낮은 체력

**학습 포인트**:
- 여러 적 타입 동시 관리
- 암살자형 적 대응
- medium 티어 적 등장으로 화력 증가 필요성 인식

---

### 2분: + 처녀귀신, 악령

**목표**: 원거리 공격 적 등장, 전술적 판단 요구

| 항목 | 설정 |
|------|------|
| **등장 적** | 0-1분 적 + **처녀귀신, 악령** |
| **난이도 분포** | low 75% / medium 20% / high 5% |

**신규 적 특징**:
- **처녀귀신** (원거리): 느린 속도, 일정 거리 유지, 2초 쿨타임 투사체 공격
- **악령** (빠른 원거리): 빠른 속도, 1.5초 쿨타임 투사체 공격

**학습 포인트**:
- 원거리 적 우선순위 판단
- 근접 적과 원거리 적 동시 대처
- 위치 선정의 중요성

---

### 3분: + 수귀, 저승사자

**목표**: 특수 메커니즘 적 등장, 빌드 완성도 요구

| 항목 | 설정 |
|------|------|
| **등장 적** | 0-2분 적 + **수귀, 저승사자** |
| **난이도 분포** | low 60% / medium 30% / high 10% |

**신규 적 특징**:
- **수귀** (균형형): 중간 속도, 중간 스탯
- **저승사자** (암살자): 매우 빠른 속도, 높은 공격력, 낮은 체력

**학습 포인트**:
- 극단적인 스탯의 적 대처
- high 티어 적의 위협 증가

---

### 4분: + 토템 (전체 9종)

**목표**: 모든 적 타입 등장

| 항목 | 설정 |
|------|------|
| **등장 적** | 0-3분 적 + **토템** (전체 9종) |
| **난이도 분포** | low 45% / medium 40% / high 15% |

**신규 적 특징**:
- **토템** (느린 초탱커): 매우 느린 속도, 가장 높은 체력, 높은 공격력

**학습 포인트**:
- 전체 적 조합 대응
- 빌드 완성도 중요성

---

### 5분 이후: 최종 단계

**목표**: 보스 준비, 최고 난이도

| 항목 | 설정 |
|------|------|
| **등장 적** | 전체 9종 |
| **난이도 분포** | low 30% / medium 45% / high 25% |

**특징**:
- 모든 적 타입 등장
- high 티어 비율 최대 (25%)
- 10분 보스 준비 단계

**학습 포인트**:
- 최종 빌드 테스트
- 복합적인 위협 상황 대처
- 보스전 대비 자원 관리

---

## 웨이브 스폰 시스템

### 스폰 메커니즘

#### 방향 기반 스폰
```
        ↓ 위쪽 (side 0)

← 왼쪽(3)  플레이어  오른쪽(1) →

        ↑ 아래쪽 (side 2)
```

- 4방향 (위, 오른쪽, 아래, 왼쪽) 화면 밖에서 스폰
- 각 웨이브마다 중복 없이 방향 선택 (가능한 한)
- 화면 크기 기준 마진(100px) 외부에서 생성

#### 그룹 클러스터링

- 각 방향마다 중심점 생성
- 중심점 주변 반경 200px 범위 내 랜덤 분산
- 그룹당 2-3마리씩 밀집 배치
- **몰려오는 느낌** 연출

#### 월드 경계 제한

- 테두리(border) 안쪽 50px 마진 유지
- 스폰 위치가 경계를 벗어날 경우 자동 보정
- 화면 밖이면서 월드 안쪽에서만 생성

### 동적 난이도 조정

#### 스폰 간격 감소
```typescript
초기: 2.5초
최소: 1.2초
감소량: 레벨업 시 -0.1초
```

#### 그룹 수 증가
```typescript
초기: 1개 그룹
최대: 3개 그룹
증가 주기: 60초마다 +1그룹
```

#### 최대 활성 적 수 제한
```typescript
최대 개체 수: 150마리
목적: 성능 최적화
```

---

## 난이도 곡선

### 티어별 스탯 배율

| 티어 | 체력 배율 | 공격력 배율 | XP 드랍 |
|------|-----------|-------------|---------|
| **low** | 1.0x (30 HP) | 1.0x (10 DMG) | 5 XP |
| **medium** | 3.5x (105 HP) | 3.5x (35 DMG) | 25 XP |
| **high** | 15.0x (450 HP) | 15.0x (150 DMG) | 100 XP |

### 시간대별 티어 확률 변화

```
0-1분:   ████████████████████████████████████████ 100% low

1-2분:   ████████████████████████████████████ 90% low
         ████ 10% medium

2-3분:   ██████████████████████████████ 75% low
         ████████ 20% medium
         ██ 5% high

3-4분:   ████████████████████████ 60% low
         ████████████ 30% medium
         ████ 10% high

4-5분:   ██████████████████ 45% low
         ████████████████ 40% medium
         ██████ 15% high

5분+:    ████████████ 30% low
         ██████████████████ 45% medium
         ██████████ 25% high
```

### DPS 요구량 곡선 (예상)

```
시간  |  필요 DPS  |  이유
-----|-----------|----------------------------------
0-2분 |  ~50 DPS  | 튜토리얼, low 티어만
2-4분 | ~100 DPS  | medium 티어 30% 등장
4-6분 | ~200 DPS  | high 티어 등장, 스폰 간격 감소
6-8분 | ~350 DPS  | high 티어 20%, 빠른 스폰
8-10분 | ~500 DPS | 최종 웨이브, 보스 준비
```

---

## 밸런스 수치

### 적 타입별 스폰 확률

```typescript
enemySpawnRates: {
  skeleton: 0.15,      // 15% - 빠른 약체
  dokkaebi: 0.14,      // 14% - 탱커
  mask: 0.15,          // 15% - 암살자
  maidenGhost: 0.1,    // 10% - 원거리
  evilSpirit: 0.06,    // 6% - 빠른 원거리
  fox: 0.14,           // 14% - 균형형
  grimReaper: 0.05,    // 5% - 암살자
  totem: 0.13,         // 13% - 느린 탱커
  waterGhost: 0.08,    // 8% - 균형형
}
```

### 적 타입별 스탯 (low 티어 기준)

| 적 이름 | 체력 | 속도 | 공격력 | 특징 |
|---------|------|------|--------|------|
| **스켈레톤** | 20 (67%) | 130 | 8 (80%) | 빠른 유리대포 |
| **탈령** | 18 (60%) | 150 | 15 (150%) | 매우 빠른 암살자 |
| **수귀** | 25 (83%) | 110 | 9 (90%) | 균형형 |
| **여우** | 35 (117%) | 120 | 10 (100%) | 빠른 균형형 |
| **도깨비** | 50 (167%) | 75 | 12 (120%) | 느린 탱커 |
| **처녀귀신** | 27 (90%) | 85 | 10 (100%) | 원거리 (2초 쿨) |
| **악령** | 24 (80%) | 110 | 8 (80%) | 빠른 원거리 (1.5초 쿨) |
| **저승사자** | 22 (73%) | 140 | 16 (160%) | 빠른 암살자 |
| **토템** | 60 (200%) | 50 | 11 (110%) | 느린 초탱커 |

### 스폰 시스템 밸런스

```typescript
SPAWN_BALANCE = {
  initialInterval: 3.5,        // 초기 웨이브 간격 (초) - 더 여유 있게 시작
  minInterval: 1.5,            // 최소 웨이브 간격 - 너무 빠르지 않게 조정
  intervalReduction: 0.1,      // 난이도 증가 시 감소량

  minGroupSize: 2,             // 그룹당 최소 적 수 - 초반 압박 완화
  maxGroupSize: 4,             // 그룹당 최대 적 수 - 후반 압박 완화
  minGroups: 1,                // 최소 그룹 수 - 초반 1그룹부터 시작
  maxGroups: 6,                // 최대 그룹 수 - 극후반 압박 완화 (12 -> 6)

  clusterRadius: 180,          // 그룹 내 퍼짐 정도 - 더 뭉쳐서 몰려오는 느낌
  groupIncreaseInterval: 60,   // 그룹 증가 주기 (초)
  maxActiveEnemies: 120,       // 최대 활성 적 개체 수 - 성능 및 압박 완화
  spawnMargin: 600,            // 화면 밖 스폰 마진
}
```

**밸런스 조정 이유**:
- **초반 압박 완화**: `initialInterval` 2→3.5초로 증가, `minGroups` 2→1로 감소하여 튜토리얼 단계에서 여유 확보
- **후반 압박 완화**: `maxGroups` 12→6, `maxGroupSize` 8→4로 감소하여 극후반 적 수를 96마리→24마리로 대폭 축소
- **몰려오는 느낌 강화**: `clusterRadius` 400→180으로 감소하여 적들이 더 밀집되어 그룹으로 느껴짐
- **점진적 난이도 곡선**: 티어 확률이 더 완만하게 증가 (1분에 10% medium, 2분에 5% high)
- **성능 최적화**: `maxActiveEnemies` 150→120으로 감소

---

## 구현 세부사항

### 시간대별 적 필터링

구간별로 등장하는 적을 제한하기 위해 `SpawnSystem.ts`에 시간대별 필터링 로직 추가:

```typescript
/**
 * 게임 시간에 따라 등장 가능한 적 타입 리스트 반환 (1분마다 2종씩 추가)
 */
private getAvailableEnemyTypes(gameTime: number): readonly string[] {
  const phases = SPAWN_BALANCE.timePhases;
  const types = SPAWN_BALANCE.enemyTypesByPhase;

  if (gameTime < phases.phase1) {
    // 0분: 스켈레톤, 도깨비 (2종)
    return types.phase0;
  } else if (gameTime < phases.phase2) {
    // 1분: + 여우, 탈령 (4종)
    return types.phase1;
  } else if (gameTime < phases.phase3) {
    // 2분: + 처녀귀신, 악령 (6종)
    return types.phase2;
  } else if (gameTime < phases.phase4) {
    // 3분: + 수귀, 저승사자 (8종)
    return types.phase3;
  } else if (gameTime < phases.final) {
    // 4분: + 토템 (9종)
    return types.phase4;
  } else {
    // 5분 이후: 전체
    return types.final;
  }
}
```

### 확률 정규화

시간대별 등장 가능한 적만 필터링 후 확률 재계산:

```typescript
/**
 * 가용 적 타입 중 확률에 따라 선택
 */
private selectEnemyType(availableTypes: string[]): string {
  const rates = SPAWN_BALANCE.enemySpawnRates;

  // 가용 타입의 확률만 추출
  let totalRate = 0;
  const filteredRates: { [key: string]: number } = {};

  for (const type of availableTypes) {
    filteredRates[type] = rates[type as keyof typeof rates];
    totalRate += filteredRates[type];
  }

  // 확률 정규화 (합을 1.0으로)
  const normalizedRates: { [key: string]: number } = {};
  for (const type of availableTypes) {
    normalizedRates[type] = filteredRates[type] / totalRate;
  }

  // 정규화된 확률로 선택
  const rand = Math.random();
  let cumulative = 0;

  for (const type of availableTypes) {
    cumulative += normalizedRates[type];
    if (rand < cumulative) {
      return type;
    }
  }

  return availableTypes[0]; // 폴백
}
```

### 몰려오는 느낌 강화

1. **그룹 수 증가**: `maxGroups: 2 → 3`
2. **클러스터 반경 유지**: 200px (너무 넓으면 분산되어 보임)
3. **스폰 간격 감소**: 최소 1.2초까지
4. **4방향 동시 스폰**: 여러 방향에서 동시에 몰려옴

---

## 관련 파일

### 핵심 파일
- [SpawnSystem.ts](../../src/systems/SpawnSystem.ts) - 스폰 시스템 로직
- [balance.config.ts](../../src/config/balance.config.ts) - 밸런스 수치
- [enemies.ts](../../src/game/data/enemies.ts) - 티어 확률 계산

### 적 엔티티 파일
- [BaseEnemy.ts](../../src/game/entities/enemies/BaseEnemy.ts) - 적 기본 클래스
- 각 적 타입별 클래스 (SkeletonEnemy, DokkaebiEnemy 등)

---

## 향후 개선 사항

### 추가 고려 사항

- [ ] **엘리트 몹 시스템**: 일정 확률로 강화된 개체 등장
- [ ] **이벤트 웨이브**: 특정 시간대 대량 스폰 이벤트
- [ ] **적 조합 패턴**: 탱커 + 원거리 등 전략적 조합
- [ ] **지형 활용**: 맵의 특정 지역에서만 등장하는 적
- [ ] **네임드 적**: 보스 전 중간 보스 개념

### 밸런스 튜닝

- [ ] 플레이테스트 기반 DPS 요구량 조정
- [ ] 적 타입별 스폰 확률 미세 조정
- [ ] 티어 배율 재조정 (현재 3.5x, 15x)
- [ ] 원거리 적 비율 조정 (현재 16%)

---

**작성자**: 개발팀
**최종 수정일**: 2025-11-08
**문서 버전**: 1.0
